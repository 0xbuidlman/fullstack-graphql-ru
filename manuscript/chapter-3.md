# 3. API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã GraphQL

HTTP-—Å–µ—Ä–≤–µ—Ä ‚Äî –Ω–∞–∏–±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ö–µ–º—É GraphQL. –°–æ–∑–¥–∞–Ω–∏–µ API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ GraphQL ‚Äî —ç—Ç–æ –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª—å—à–µ, —á–µ–º –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º. –í —ç—Ç–æ–π –≥–ª–∞–≤–µ –≤—ã —É–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–µ, –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã GraphQL.

![–°–µ—Ä–≤–µ—Ä](images/server.png)

–í—ã —É–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å GraphQL-—Å—Ö–µ–º—ã —Å –ø–æ–º–æ—â—å—é Apollo Server. –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤–∞—à–∏ —Ä–µ–∑–æ–ª–≤–µ—Ä—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –í—ã –¥–æ–±–∞–≤–∏—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π API. –ù–∞–∫–æ–Ω–µ—Ü, –≤—ã –Ω–∞—É—á–∏—Ç–µ—Å—å, –∫–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º.

![–°–ª–æ–∏ —Å–µ—Ä–≤–µ—Ä–∞](images/server-layers.png)

–í—Å–µ —ç—Ç–∞–ø—ã —ç—Ç–æ–π –≥–ª–∞–≤—ã –∏–º–µ—é—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.

–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å –∏–∑—É—á–µ–Ω–∏—è —Ç–æ–≥–æ, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å API, –∏—Å–ø–æ–ª—å–∑—É—è Apollo Server.

## 3.1 –°–µ—Ä–≤–µ—Ä

Apollo Server ‚Äî —ç—Ç–æ —Å–µ—Ä–≤–µ—Ä —Å –æ—Ç–∫—Ä—ã—Ç—ã–º –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–æ–º, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–µ–π GraphQL. –≠—Ç–æ –≥–æ—Ç–æ–≤—ã–π –∫ —Ä–∞–±–æ—Ç–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ, –ø—Ä–æ—Å—Ç–æ–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–ø–æ—Å–æ–± –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è GraphQL-—Å—Ö–µ–º, —Ç–∞–∫ —á—Ç–æ–±—ã HTTP-–∫–ª–∏–µ–Ω—Ç—ã –º–æ–≥–ª–∏ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.

![HTTP](images/http.png)

–í—ã —É–∂–µ —Å–æ–∑–¥–∞–ª–∏ —Å—Ö–µ–º—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `graphql-tools` –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≥–ª–∞–≤–µ, –ø–æ—ç—Ç–æ–º—É –ø—É–±–ª–∏—á–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –µ—ë —Å –ø–æ–º–æ—â—å—é Apollo Server –Ω–µ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∏–∫–∞–∫–æ–≥–æ —Ç—Ä—É–¥–∞.

```js
const { ApolloServer } = require("apollo-server");

const schema = require("./schema");

const server = new ApolloServer({ schema });

server.listen().then(({ url }) => {
  console.log(`üöÄ  Server ready at ${url}`);
});
```

–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ! –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `server.listen()` –∏ —É –≤–∞—Å –µ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–∏–π API –¥–ª—è GraphQL. –°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞, —á—Ç–æ–±—ã —É –≤–∞—Å –±—ã–ª–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–ø–∏—è –ø—Ä–æ–µ–∫—Ç–∞.

[–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞](https://glitch.com/edit/#!/remix/pinapp-server)

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´Show¬ª –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É —ç–∫—Ä–∞–Ω–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –≤ –∫–æ–º–ø–ª–µ–∫—Ç GraphQL-–∫–ª–∏–µ–Ω—Ç–∞ ‚Äî [GraphQL Playground](https://github.com/prismagraphql/graphql-playground). –≠—Ç–æ –±–æ–ª—å—à–µ, —á–µ–º –ø—Ä–æ—Å—Ç–æ –∫–ª–∏–µ–Ω—Ç GraphQL, —Å–∫–æ—Ä–µ–µ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ IDE. –£ —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –µ—Å—Ç—å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è GraphQL-—Å—Ö–µ–º—ã, –∞ —Ç–∞–∫–∂–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –±—É–¥—É—â–µ–º.

![GraphQL Playground](images/graphql-playground.png)

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—ã —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π API-—Å–µ—Ä–≤–µ—Ä GraphQL, –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É—è –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

## 3.2 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã GraphQL –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ª—é–±—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –¥–∞–Ω–Ω—ã—Ö. –û–Ω–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQL, NoSQL, –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏–ª–∏ –¥–∞–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω–µ—á–Ω—ã–µ —Ç–æ—á–∫–∏ HTTP.

![–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](images/database.png)

–í —ç—Ç–æ–π –≥–ª–∞–≤–µ –≤—ã –ø–æ–¥–∫–ª—é—á–∏—Ç–µ PinApp –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite, –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö [Knex](http://knexjs.org). Knex ‚Äî —ç—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å SQL-–∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å–æ –º–Ω–æ–≥–∏–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö SQL, —Ç–∞–∫–∏–º–∏ –∫–∞–∫ SQLite3, MySQL, Postgres –∏ –¥—Ä.

–°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ç–µ–∫—É—â—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è PinApp, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ —Å–ª–µ–¥–æ–≤–∞—Ç—å –ø–æ —Ç–µ–∫—Å—Ç—É —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞, —Ä–∞–±–æ—Ç–∞—è —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–æ–ø–∏–µ–π –ø—Ä–æ–µ–∫—Ç–∞.

[–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](https://glitch.com/edit/#!/remix/pinapp-database)

> –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ —Å–ª–µ–¥–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø–æ –Ω–∞—á–∞–ª—É —Ä–∞–±–æ—Ç—ã –≤ —Ñ–∞–π–ª–µ README –ø—Ä–æ–µ–∫—Ç–∞

–ü–æ—Å–∫–æ–ª—å–∫—É –≤—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ —Ñ–∞–π–ª–µ `resolvers.js`, –¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞.

–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–±–æ—Ä –∑–∞–ø–∏—Å–µ–π —Å –ø–æ–º–æ—â—å—é `select()`. –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∏–Ω–æ–≤ –º–æ–∂–Ω–æ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```js
pins: () => database("pins").select(),
```

–í—ã –º–æ–∂–µ—Ç–µ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ —Ü–µ–ø–æ—á–∫—É –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ Knex. –ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ `select()`, –¥–æ–±–∞–≤–∏–≤ –µ–≥–æ –≤—ã–∑–æ–≤ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `where()`.

```js
search: (_, { text }) => {
  return Promise.all([
    database("users")
      .select()
      .where("email", "like", `%${text}%`),
    database("pins")
      .select()
      .where("title", "like", `%${text}%`)
  ]);
};
```

–ï—â–µ –æ–¥–Ω–∞ –ø–æ–ª–µ–∑–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç Knex, ‚Äî —ç—Ç–æ `insert()`. –û–Ω–∞ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –í–æ—Ç —Ç–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –º—É—Ç–∞—Ü–∏—è `addPin` –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `insert`.

```js
addPin: async (_, { pin }, { token }) => {
  const [user] = await authorize(token);
  const { user: updatedUser, pin: createdPin } = await addPin(user, pin);
  await database("pins").insert(createdPin);
  return createdPin;
},
```

–§–∞–π–ª `database.js` —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä Knex –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –º–æ–¥—É–ª—è. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–π —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä Knex —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ —Ñ–∞–π–ª–∞ —Å –∏–º–µ–Ω–µ–º `knexfile.js`.

```js
const database = require("knex")(require("./knexfile"));

module.exports = database;
```

–£ Knex –∏–º–µ–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ç–∏–ª–∏—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ. –£—Ç–∏–ª–∏—Ç–∞ CLI —Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ `knexfile.js`. –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PinApp –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```js
module.exports = {
  client: "sqlite3",
  connection: {
    filename: ".data/database.sqlite"
  }
};
```

> [Glitch](https://glitch.com) –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `.data`. –ò–º–µ–Ω–Ω–æ –ø–æ —ç—Ç–æ–π –ø—Ä–∏—á–∏–Ω–µ —Ñ–∞–π–ª `database.sqlite` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SQL-—Ñ–∞–π–ª–∞, ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. Knex –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.

–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ `npx knex migrate:make create_users_table` —Å–æ–∑–¥–∞—Å—Ç —Ñ–∞–π–ª —Å –∏–º–µ–Ω–µ–º `[date]_create_users_table.js` –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `.migrations`. –≠—Ç–æ—Ç —Ñ–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–≤–∞ –º–µ—Ç–æ–¥–∞ ‚Äî `up` –∏ `down`. –≠—Ç–∏ –º–µ—Ç–æ–¥—ã —è–≤–ª—è—é—Ç—Å—è —Å–≤–æ–µ–≥–æ —Ä–æ–¥–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º. –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∏–º–µ—Ç—å –¥–≤–∞ –ø–æ–ª—è: `id` –∏ `email`. –£ –æ–±–æ–∏—Ö –ø–æ–ª–µ–π —É–∫–∞–∑–∞–Ω —Ç–∏–ø `string`, –∞ –ø–æ–ª–µ `id` –∑–∞–¥–∞–Ω–æ –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á.

```js
exports.up = function(knex) {
  return knex.schema.createTable("users", function(table) {
    table.string("id").primary();
    table.string("email");
  });
};

exports.down = function(knex) {
  return knex.schema.dropTable("users");
};
```

–í —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –µ—â–µ –æ–¥–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è ‚Äî `[date]_create_pins_migration`. –≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—è—Ç—å —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö (`string`) –ø–æ–ª–µ–π: `id`, `title`, `link`, `image` –∏ `pin_id`.

```js
exports.up = function(knex) {
  return knex.schema.createTable("pins", function(table) {
    table.string("id").primary();
    table.string("title");
    table.string("link");
    table.string("image");
    table
      .string("user_id")
      .references("id")
      .inTable("users")
      .onDelete("CASCADE")
      .onUpdate("CASCADE");
  });
};

exports.down = function(knex) {
  return knex.schema.dropTable("pins");
};
```

–í—ã–ø–æ–ª–Ω–∏—Ç–µ `npm run setup-db` –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –∫–ª—é—á–µ `scripts` —Ñ–∞–π–ª–∞ `package.json`:

```json
"setup-db": "knex migrate:latest"`
```

–ò–∑—É—á–µ–Ω–∏–µ SQL –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ —Ä–∞–º–∫–∏ –∫–Ω–∏–≥–∏: –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑—É—á–∏—Ç—å —ç—Ç–æ—Ç —è–∑—ã–∫, –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–∏–≥—É. –ü–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–æ–≤ Knex –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö SQL, –∞ –µ—â–µ —É –Ω–µ–≥–æ –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω–∞—è [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](http://knexjs.org). –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –Ω–µ–π, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ –¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.

## 3.3 –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–û–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GraphQL: ¬´–ö—É–¥–∞ –ø–æ–º–µ—Å—Ç–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é?¬ª. –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Å–ª–æ–µ GraphQL? –ò–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö? –ê –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏? –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ –æ—Ç–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–æ–≥–æ, –∫–∞–∫–æ–π API –≤—ã —Å–æ–∑–¥–∞–µ—Ç–µ, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã ‚Äî –ø–æ–º–µ—Å—Ç–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –Ω–∞ –±–∏–∑–Ω–µ—Å-—É—Ä–æ–≤–Ω–µ. –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–æ–¥–∞, —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π, –Ω–∞ –±–∏–∑–Ω–µ—Å-—É—Ä–æ–≤–Ω–µ ‚Äî —ç—Ç–æ [–ø–æ–¥—Ö–æ–¥ Facebook](https://dev-blog.apollodata.com/graphql-at-facebook-by-dan-schafer-38d65ef075af).

![–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞](images/business-logic.png)

–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏, —á—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–∏–º –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º. –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –ø–æ–∫–∞–∂–µ—Ç, –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ –≤ PinApp.

–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–∫–∞–∂—É—Ç —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –ø–æ—á—Ç—É, –∏–º –ø—Ä–∏–¥—ë—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–π–¥—É—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞, —Ç–æ –∑–Ω–∞—á–∏—Ç —Ç–∞–∫–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ø–æ—á—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞). –ê –¥–∞–ª–µ–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ —Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –±–æ–ª–µ–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω—ã–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è.

–°–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –ø–æ–¥–æ–±–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—Ç–∞—Ä–æ–π –¥–æ–±—Ä–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ –ø–∞—Ä–æ–ª—é, –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ –≤–∞–º –≤–æ–æ–±—â–µ –Ω–µ –Ω—É–∂–Ω–æ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –ø–∞—Ä–æ–ª—è–º–∏. –¢–æ, —á—Ç–æ –º—ã –Ω–µ —Ö—Ä–∞–Ω–∏–º –ø–∞—Ä–æ–ª–∏ —Ç–∞–∫–∂–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∫—Ä–∞–π–Ω–∏—Ö –º–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∏—Ö –∑–∞—â–∏—Ç—ã. –ï—â–µ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤–∞—à–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–µ –Ω—É–∂–Ω–æ –∑–∞—Ö–æ–¥–∏—Ç—å –Ω–∞ –æ—á–µ—Ä–µ–¥–Ω–æ–π —Å–∞–π—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Å–∏—Ç –∏—Ö —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.

```gherkin
Feature: Email based authentication

  Scenario: Send magic link
    Given a user enters his email address
    When he/she submits the form
    Then he/she should receive an email with a link to the app that contains his token

  Scenario: Verify email
    Given a user receives an email with a magic link
    When he/she clicks the link
    Then he/she should see a loading screen
    When the app verifies the token
    Then he/she should see an email confirmation message
```

–ì–æ–≤–æ—Ä—è –≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö GraphQL, –æ–±–∞ —ç—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è (—Å—Ü–µ–Ω–∞—Ä–∏—è) –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ –º—É—Ç–∞—Ü–∏—è—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π GraphQL-—Å—Ö–µ–º–µ ‚Äî `sendShortLivedToken` –∏ `createLongLivedToken`. –ü–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—É—á–∞–µ—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ —Ç–∏–ø–∞ `String`. –í—Ç–æ—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—É—á–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω, –∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω.

```graphql
type Mutation {
  # ...
  sendShortLivedToken(email: String!): Boolean
  createLongLivedToken(token: String!): String
}
```

–°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Ö–æ–¥–æ–º –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ.

[–°–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ](https://glitch.com/edit/#!/remix/pinapp-email-authentication)

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, –∫–∞–∫ –≤—ã–≥–ª—è–¥—è—Ç —Ä–µ–∑–æ–ª–≤–µ—Ä—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–æ–π.

–†–µ–∑–æ–ª–≤–µ—Ä `sendShortLivedToken` –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ. –ï—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–Ω –¥–æ–ª–∂–µ–Ω –≤—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω —Å –Ω–µ–±–æ–ª—å—à–∏–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –ø–æ—á—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```js
sendShortLivedToken: async (_, { email }) => {
  let user;
  const userExists = await database("users")
    .select()
    .where({ email });
  if (userExists.length) {
    user = userExists[0];
  } else {
    user = createUser(email);
    await database("users").insert(user);
  }
  const token = createShortLivedToken(user);
  return sendShortLivedToken(email, token);
};
```

–≠—Ç–æ—Ç —Ä–µ–∑–æ–ª–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞ `business-logic.js` ‚Äî `createShortLivedToken` –∏ `sendShortLivedToken`.

–ü–µ—Ä–≤—ã–π —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é `jsonwebtoken` –∏–∑ NPM-–ø–∞–∫–µ—Ç–∞ [`sign`](https://github.com/auth0/node-jsonwebtoken#jwtsignpayload-secretorprivatekey-options-callback). –£ —ç—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø—è—Ç—å—é –º–∏–Ω—É—Ç–∞–º–∏.

```js
const createShortLivedToken = ({ email, id }) => {
  return jsonwebtoken.sign(
    { id, email },
    process.env.SECRET,
    {
      expiresIn: "5m"
    }
  );
};
```

–í—Ç–æ—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è `sendShortLivedToken` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –≤ —Ñ–∞–π–ª–µ `email.js`, –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º `sendMail`.

```js
const sendShortLivedToken = (email, token) => {
  return sendMail({
    from: '"Julian" <julian@graphql.college>',
    to: email,
    text: `${process.env.APP_URL}/verify?token=${token}`,
    html: `<a href="${
      process.env.APP_URL
    }/verify?token=${token}" target="_blank">Authenticate</a>`,
    subject: "Auth token"
  });
};
```

–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—á—Ç—ã –≤–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è –ø–∞–∫–µ—Ç–æ–º `nodemailer`. –≠—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ —á–µ—Ä–µ–∑ SMTP-—Å–µ—Ä–≤–µ—Ä. –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞—Ç—å –ø–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ‚Äî [Ethereal](https://ethereal.email/messages. –≠—Ç–æ —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π –ø–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Å–æ–∑–¥–∞—Ç–µ–ª—è–º–∏ Nodemailer, —è–≤–ª—è–µ—Ç—Å—è –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã–º —Å–ø–æ—Å–æ–±–æ–º —Å–æ–∑–¥–∞–Ω–∏—è SMTP-—Å–ª—É–∂–±—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –†–∞–∑—É–º–µ–µ—Ç—Å—è, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞, –≤–∞–º —Å–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å SMTP. [Sendgrid](https://sendgrid.com/) –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω.

```js
const nodemailer = require("nodemailer");

const transporter = nodemailer.createTransport({
  host: "smtp.ethereal.email",
  port: 587,
  auth: {
    user: process.env.MAIL_USER,
    pass: process.env.MAIL_PASSWORD
  }
});

function sendMail({ from, to, subject, text, html }) {
  const mailOptions = {
    from,
    to,
    subject,
    text,
    html
  };
  return new Promise((resolve, reject) => {
    transporter.sendMail(mailOptions, (error, info) => {
      if (error) {
        return reject(error);
      }
      resolve(info);
    });
  });
}

module.exports = sendMail;
```

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `createLongLivedToken` –Ω–∞–º–Ω–æ–≥–æ –ø—Ä–æ—â–µ, —á–µ–º `sendShortLivedToken`. –ü–µ—Ä–≤—ã–π —Ä–µ–∑–æ–ª–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ —Ñ–∞–π–ª–∞ `business-logic.js`, –ø—Ä–æ–≤–µ—Ä—è—é—â–∞—è —Ç–æ–∫–µ–Ω, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω —Å –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è, —Ä–∞–≤–Ω—ã–π —Ç—Ä–∏–¥—Ü–∞—Ç—å –¥–Ω–µ–π.

```js
const createLongLivedToken = token => {
  try {
    const { id, email } = jsonwebtoken.verify(
      token,
      process.env.SECRET
    );
    const longLivedToken = jsonwebtoken.sign(
      { id, email },
      process.env.SECRET,
      { expiresIn: "30 days" }
    );
    return Promise.resolve(longLivedToken);
  } catch (error) {
    console.error(error);
    throw error;
  }
};
```

–î–≤–∏–≥–∞–π—Ç–µ—Å—å –¥–∞–ª—å—à–µ –∏ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–π—Ç–µ —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—à–µ–π —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å—å—é Ethereal. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—Å—ë –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, –∑–∞–π–¥–∏—Ç–µ –≤ GraphQL Playground, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É ¬´Show¬ª, –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è, –∏—Å–ø–æ–ª—å–∑—É—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –ø–æ—á—Ç—É (–∏–ª–∏ –ª—é–±—É—é –¥—Ä—É–≥—É—é, —Ç–∞–∫ –∫–∞–∫ Ethereal –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ :D).

## 3.4 –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –≤—ã —É–∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `graphql-import` –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ Node.js GraphQL –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º. –ò–º–ø–æ—Ä—Ç GraphQL –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –≤ GraphQL SDL.

–ù–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –æ–±—Ä–∞–∑—Ü–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Ä–æ–ª—è–º, –Ω–æ –ø–æ–¥–æ–±–Ω—ã–π –Ω–µ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –°–µ–π—á–∞—Å –≤—Å–µ —Ä–µ–∑–æ–ª–≤–µ—Ä—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ `resolvers.js`, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤ ‚Äî –≤ —Ñ–∞–π–ª–µ `schema.graphql`, –∞ –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ ‚Äî –≤ —Ñ–∞–π–ª–µ b`business-logic.js`. –ü–æ –º–µ—Ä–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø—Ä–æ–µ–∫—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤—Å–µ –±–æ–ª—å—à–µ –∏ –±–æ–ª—å—à–µ, —ç—Ç–∏ —Ç—Ä–∏ —Ñ–∞–π–ª–∞ —Å—Ç–∞–Ω—É—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º–∏ –∏ –Ω–µ—É–ø—Ä–∞–≤–ª—è–µ–º—ã–º–∏.

–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:

![–¢–µ–∫—É—â–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞](images/current-file-structure.png)

–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Ä–∞–∑–¥–µ–ª–∏—Ç—å `schema.graphql`, `resolvers.js` –∏ `business-logic.js` –Ω–∞ —Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: `authentication`, `pins` –∏ `search`. –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –±—É–¥–µ—Ç —Ç–∞–∫–æ–π, –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∏–∂–µ:

![–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞](images/final-file-structure.png)

–°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ –ø—Ä–æ–µ–∫—Ç, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é.

[–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤](https://glitch.com/edit/#!/remix/pinapp-files)

–û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ —Å—Ö–µ–º—ã GraphQL –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –±—É–¥–µ—Ç —Ñ–∞–π–ª `schema.graphql`. –†–∞–∑–Ω–∏—Ü–∞ –≤ —Ç–æ–º, —á—Ç–æ –≤ –Ω–µ–º –Ω–µ –±—É–¥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è –∫–∞–∫–∏–µ-–ª–∏–±–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤, –∞ –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã –∏–∑ —Ñ–∞–π–ª–∞ `schema.graphql` –≤ –∫–∞–∂–¥–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ö–µ–º–∞ –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã, –∏—Å–ø–æ–ª—å–∑—É—è –æ–ø–µ—Ä–∞—Ç–æ—Ä `import`, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π `graphql-import`. –ï–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å: `# import * from "module-name.graphql"`.

```graphql
# import * from "authentication/schema.graphql"
# import * from "pins/schema.graphql"
# import * from "search/schema.graphql"
```

–¢–∞–∫–æ–π —Å–ø–æ—Å–æ–± –∏–º–ø–æ—Ä—Ç–∞ GraphQL SDL –≤–æ–∑–º–æ–∂–µ–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É —Ñ–∞–π–ª `schema.js` –∑–∞–≥—Ä—É–∂–∞–µ—Ç `schema.graphql` —Å–ª–µ–¥—É—é—â–∏–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–º –∫–æ–¥–∞:

```js
const { importSchema } = require("graphql-import");

const typeDefs = importSchema("schema.graphql");
// ...
```

–ü–æ–¥–æ–±–Ω–æ–µ —Å—Ö–µ–º–µ, –≥–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∑–æ–ª–≤–µ—Ä–æ–≤ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π. –≠—Ç–æ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –±—É–¥–µ—Ç `resolvers.js`. Node.js —É–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ø–æ—Å–æ–± –∏–º–ø–æ—Ä—Ç–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–º–æ—â—å—é `require`, –ø–æ—ç—Ç–æ–º—É –≤–∞–º –Ω–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É. –î–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ—Ç —Ñ–∞–π–ª –Ω–µ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π, –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö —Ä–µ–∑–æ–ª–≤–µ—Ä–æ–≤. –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –Ω–∞ —á–∏—Å—Ç–æ–º JavaScript-–∫–æ–¥–µ, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –æ–¥–Ω–∞–∫–æ `lodash.merge` ‚Äî —ç—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–∞ JavaScript-–æ–±—ä–µ–∫—Ç–æ–≤.

```js
const merge = require("lodash.merge");

const searchResolvers = require("./search/resolvers.js");
const authenticationResolvers = require("./authentication/resolvers.js");
const pinsResolvers = require("./pins/resolvers.js");

const resolvers = merge(
  searchResolvers,
  authenticationResolvers,
  pinsResolvers
);

module.exports = resolvers;
```

–í –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ `business-logic.js`, `resolvers.js` –∏ `schema.graphql`. –†–∞–∑–¥–µ–ª–∏—Ç–µ —Ñ–∞–π–ª `business-logic.js` –Ω–∞ `authentication/index.js` –∏ `pins/index.js`. –†–∞–∑–¥–µ–ª–∏—Ç–µ `resolvers.js` –Ω–∞`authentication/resolvers.js`, `pins/resolvers.js` –∏ `search/resolvers.js`. –ò –Ω–∞–ø–æ—Å–ª–µ–¥–æ–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ `schema.graphql` –Ω–∞ —Ç—Ä–∏ –Ω–æ–≤—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

–í—Å—ë! –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–π –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö ‚Äî —ç—Ç–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π —Å–ø–æ—Å–æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞. –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–ª–∏—à–Ω–∏–º –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤, –Ω–æ –æ–Ω —Å –ª–∏—Ö–≤–æ–π –æ–∫—É–ø–∞–µ—Ç—Å—è –≤ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö.

## 3.5 –†–µ–∑—é–º–µ

–í—ã —É–∑–Ω–∞–ª–∏, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å API –Ω–∞ GraphQL, –∏—Å–ø–æ–ª—å–∑—É—è Apollo Server. –ù–∞—á–∞–≤ —Å –ø—Ä–æ—Å—Ç–æ–π GraphQL-—Å—Ö–µ–º—ã, –≤—ã —É–∑–Ω–∞–ª–∏, –∫–∞–∫ –æ–±–µ—Ä–Ω—É—Ç—å —ç—Ç—É —Å—Ö–µ–º—É HTTP-—Å–ª–æ–µ–º –ø—Ä–∏ –ø–æ–º–æ—â–∏ ApolloServer. –í—ã –¥–æ–±–∞–≤–∏–ª–∏ —Å–ª–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–∏—Å—å Knex, –∞ —Ç–∞–∫–∂–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º Nodemailer. –ù–∞–∫–æ–Ω–µ—Ü, –≤—ã –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª–∏ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GraphQL Import.

–í —Å–ª–µ–¥—É—é—â–µ–π –≥–ª–∞–≤–µ –≤—ã –Ω–∞—É—á–∏—Ç–µ—Å—å, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å GraphQL-–∫–ª–∏–µ–Ω—Ç—ã –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ Apollo Client, –∞ —Ç–∞–∫–∂–µ —Å–¥–µ–ª–∞–µ—Ç–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞ React, –∫–æ—Ç–æ—Ä—ã–π –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–º API GraphQL.

